<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Imagens Base64 - MapCity</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .warning { border-color: #ff9800; background-color: #fff3e0; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .image-item {
            text-align: center;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fafafa;
        }
        .image-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        .image-preview.error {
            border-color: red;
            background-color: #ffcdd2;
        }
        .image-info {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Teste de Imagens Base64 - MapCity</h1>
        
        <div class="test-section info">
            <h3>Status da Conex√£o</h3>
            <p>Backend: <span id="backend-status">Verificando...</span></p>
            <p>Total de registros: <span id="total-records">-</span></p>
            <button onclick="recarregarDados()">üîÑ Recarregar Dados</button>
            <button onclick="abrirConsole()">üîç Abrir Console do Navegador</button>
        </div>
        
        <div id="loading" class="loading">
            üîÑ Carregando dados do backend...
        </div>
        
        <div id="results"></div>
        
        <div class="test-section warning">
            <h3>‚ÑπÔ∏è Como usar este teste</h3>
            <ul>
                <li>‚úÖ <strong>Verde:</strong> Imagem carregou corretamente</li>
                <li>‚ùå <strong>Vermelho:</strong> Erro ao carregar imagem</li>
                <li>‚ö†Ô∏è <strong>Amarelo:</strong> Formato inesperado</li>
                <li>Clique em "Abrir Console" para ver logs detalhados</li>
            </ul>
        </div>
    </div>

    <script>
        let dadosOriginais = [];
        
        function abrirConsole() {
            alert('Pressione F12 para abrir o Console do Navegador e ver os logs detalhados!');
        }
        
        async function recarregarDados() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            await carregarETestarImagens();
        }
        
        async function carregarETestarImagens() {
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const backendStatus = document.getElementById('backend-status');
            const totalRecords = document.getElementById('total-records');
            
            try {
                console.log('üöÄ INICIANDO TESTE DE IMAGENS');
                console.log('üì° Fazendo requisi√ß√£o para http://localhost:3001/lugares...');
                
                const response = await fetch('http://localhost:3001/lugares');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const dados = await response.json();
                dadosOriginais = dados;
                
                console.log('‚úÖ Dados recebidos com sucesso!');
                console.log('üìä Total de registros:', dados.length);
                console.log('üóÇÔ∏è Dados completos:', dados);
                
                backendStatus.textContent = '‚úÖ Conectado';
                backendStatus.style.color = 'green';
                totalRecords.textContent = dados.length;
                
                loadingDiv.style.display = 'none';
                
                if (dados.length === 0) {
                    resultsDiv.innerHTML = '<div class="test-section warning"><h3>‚ö†Ô∏è Nenhum registro encontrado</h3><p>Adicione alguns marcadores com imagens para testar.</p></div>';
                    return;
                }
                
                // Processar cada registro
                dados.forEach((lugar, index) => {
                    console.log(`\nüîç PROCESSANDO REGISTRO ${index + 1}/${dados.length}`);
                    console.log('üìç Lugar:', lugar);
                    console.log('üñºÔ∏è Campo imagem:', lugar.imagem);
                    console.log('üìù Tipo:', typeof lugar.imagem);
                    
                    const container = document.createElement('div');
                    container.className = 'test-section';
                    
                    let html = `
                        <h3>üìç ${lugar.nome || 'Sem nome'} (ID: ${lugar.id})</h3>
                        <p><strong>Tipo:</strong> ${lugar.tipo || 'N/A'}</p>
                        <p><strong>Descri√ß√£o:</strong> ${lugar.descricao || 'N/A'}</p>
                        <p><strong>Localiza√ß√£o:</strong> ${lugar.latitude}, ${lugar.longitude}</p>
                    `;
                    
                    if (!lugar.imagem) {
                        html += '<p class="info">‚ùå Nenhuma imagem associada</p>';
                        container.className += ' warning';
                    } else {
                        html += '<div class="image-grid">';
                        
                        try {
                            if (typeof lugar.imagem === 'string') {
                                console.log('üîÑ Tentando processar imagem como string...');
                                
                                // Tentar parsear como JSON
                                try {
                                    const imageArray = JSON.parse(lugar.imagem);
                                    console.log('‚úÖ JSON parseado com sucesso:', imageArray);
                                    
                                    if (Array.isArray(imageArray)) {
                                        console.log(`üìö Array de ${imageArray.length} imagem(ns)`);
                                        
                                        imageArray.forEach((imgData, imgIndex) => {
                                            console.log(`üñºÔ∏è Imagem ${imgIndex + 1}:`, imgData);
                                            
                                            const imgSrc = imgData.data || imgData;
                                            const imgId = imgData.id || `img-${imgIndex}`;
                                            
                                            if (imgSrc && imgSrc.startsWith('data:image/')) {
                                                html += `
                                                    <div class="image-item">
                                                        <img src="${imgSrc}" 
                                                             alt="Imagem ${imgIndex + 1}" 
                                                             class="image-preview"
                                                             onload="this.style.borderColor='green'; console.log('‚úÖ Imagem ${imgIndex + 1} carregada com sucesso');"
                                                             onerror="this.classList.add('error'); this.alt='‚ùå ERRO'; console.error('‚ùå Erro ao carregar imagem ${imgIndex + 1}');">
                                                        <div class="image-info">
                                                            <strong>ID:</strong> ${imgId}<br>
                                                            <strong>Tamanho:</strong> ~${Math.round(imgSrc.length / 1024)}KB<br>
                                                            <strong>Tipo:</strong> ${imgSrc.substring(5, imgSrc.indexOf(';'))}
                                                        </div>
                                                    </div>
                                                `;
                                            } else {
                                                console.warn('‚ö†Ô∏è Formato de imagem inv√°lido:', imgSrc ? imgSrc.substring(0, 50) + '...' : 'null');
                                                html += `
                                                    <div class="image-item">
                                                        <div class="image-preview error" style="display:flex;align-items:center;justify-content:center;color:red;">
                                                            ‚ùå FORMATO INV√ÅLIDO
                                                        </div>
                                                        <div class="image-info">
                                                            <strong>Erro:</strong> Formato inv√°lido<br>
                                                            <strong>Dados:</strong> ${imgSrc ? imgSrc.substring(0, 30) + '...' : 'null'}
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        });
                                        
                                        container.className += ' success';
                                    } else {
                                        console.log('üìù Objeto √∫nico de imagem:', imageArray);
                                        const imgSrc = imageArray.data || imageArray;
                                        
                                        if (imgSrc && imgSrc.startsWith('data:image/')) {
                                            html += `
                                                <div class="image-item">
                                                    <img src="${imgSrc}" 
                                                         alt="Imagem √∫nica" 
                                                         class="image-preview"
                                                         onload="this.style.borderColor='green'; console.log('‚úÖ Imagem √∫nica carregada');"
                                                         onerror="this.classList.add('error'); this.alt='‚ùå ERRO'; console.error('‚ùå Erro ao carregar imagem √∫nica');">
                                                    <div class="image-info">
                                                        <strong>Tipo:</strong> Objeto √∫nico<br>
                                                        <strong>Tamanho:</strong> ~${Math.round(imgSrc.length / 1024)}KB
                                                    </div>
                                                </div>
                                            `;
                                            container.className += ' success';
                                        } else {
                                            console.warn('‚ö†Ô∏è Formato de objeto inv√°lido');
                                            container.className += ' error';
                                        }
                                    }
                                } catch (parseError) {
                                    console.log('üîÑ N√£o √© JSON, tentando como base64 direto...');
                                    console.log('üìù String original:', lugar.imagem.substring(0, 100) + '...');
                                    
                                    // Assumir que √© base64 direto
                                    if (lugar.imagem.startsWith('data:image/')) {
                                        html += `
                                            <div class="image-item">
                                                <img src="${lugar.imagem}" 
                                                     alt="Imagem base64 direto" 
                                                     class="image-preview"
                                                     onload="this.style.borderColor='green'; console.log('‚úÖ Base64 direto carregado');"
                                                     onerror="this.classList.add('error'); this.alt='‚ùå ERRO'; console.error('‚ùå Erro no base64 direto');">
                                                <div class="image-info">
                                                    <strong>Tipo:</strong> Base64 direto<br>
                                                    <strong>Tamanho:</strong> ~${Math.round(lugar.imagem.length / 1024)}KB
                                                </div>
                                            </div>
                                        `;
                                        container.className += ' success';
                                    } else {
                                        console.error('‚ùå Formato n√£o reconhecido');
                                        html += '<p class="error">‚ùå Formato de imagem n√£o reconhecido</p>';
                                        container.className += ' error';
                                    }
                                }
                            } else if (Array.isArray(lugar.imagem)) {
                                console.log('üìö Array direto de imagens:', lugar.imagem);
                                
                                lugar.imagem.forEach((imgPath, imgIndex) => {
                                    console.log(`üîó Path ${imgIndex + 1}:`, imgPath);
                                    
                                    if (imgPath.startsWith('/uploads/')) {
                                        const fullUrl = `http://localhost:3001${imgPath}`;
                                        html += `
                                            <div class="image-item">
                                                <img src="${fullUrl}" 
                                                     alt="Imagem ${imgIndex + 1}" 
                                                     class="image-preview"
                                                     onload="this.style.borderColor='green'; console.log('‚úÖ Upload carregado: ${imgPath}');"
                                                     onerror="this.classList.add('error'); this.alt='‚ùå ERRO'; console.error('‚ùå Erro no upload: ${imgPath}');">
                                                <div class="image-info">
                                                    <strong>Tipo:</strong> Upload<br>
                                                    <strong>Path:</strong> ${imgPath}
                                                </div>
                                            </div>
                                        `;
                                    }
                                });
                                
                                container.className += ' success';
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Erro ao processar imagem:', error);
                            html += `<p class="error">‚ùå Erro: ${error.message}</p>`;
                            container.className += ' error';
                        }
                        
                        html += '</div>';
                    }
                    
                    container.innerHTML = html;
                    resultsDiv.appendChild(container);
                });
                
                console.log('üéâ TESTE CONCLU√çDO!');
                
            } catch (error) {
                console.error('üí• ERRO GERAL:', error);
                
                backendStatus.textContent = '‚ùå Erro de conex√£o';
                backendStatus.style.color = 'red';
                
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>‚ùå Erro de Conex√£o</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique se o backend est√° rodando em http://localhost:3001</p>
                        <button onclick="recarregarDados()">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        }
        
        // Executar quando a p√°gina carregar
        window.addEventListener('load', carregarETestarImagens);
    </script>
</body>
</html>
