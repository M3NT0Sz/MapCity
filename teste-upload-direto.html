<!DOCTYPE html>
<html>
<head>
    <title>Teste Upload Direto</title>
</head>
<body>
    <h1>Teste Upload Direto</h1>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <button onclick="testarUpload()">Testar Upload</button>
    <div id="resultado"></div>

    <script>
        let uploadedImagePaths = []; // Vari√°vel global para armazenar caminhos
        
        async function testarUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const resultado = document.getElementById('resultado');
            
            if (files.length === 0) {
                resultado.innerHTML = '<p style="color: red;">Selecione pelo menos um arquivo!</p>';
                return;
            }
            
            console.log('üéØ Testando upload direto...');
            console.log('üìÅ Arquivos selecionados:', files.length);
            
            resultado.innerHTML = '<p>Enviando arquivos...</p>';
            
            try {
                const imagePaths = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`‚¨ÜÔ∏è Enviando arquivo ${i + 1}:`, file.name, file.size, 'bytes');
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    console.log('üì§ FormData criado, enviando para backend...');
                    
                    const response = await fetch('http://localhost:3001/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log(`üì° Response status para ${file.name}:`, response.status);
                    console.log(`üì° Response headers:`, response.headers);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`‚úÖ Resposta para ${file.name}:`, data);
                        
                        if (data.imagePath) {
                            imagePaths.push(data.imagePath);
                            console.log(`üìÇ Caminho adicionado: ${data.imagePath}`);
                        } else {
                            console.error(`‚ùå Resposta n√£o cont√©m imagePath:`, data);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error(`‚ùå Erro no upload de ${file.name}:`, response.status, errorText);
                    }
                }
                
                console.log('üì§ Resultado final:', imagePaths);
                uploadedImagePaths = imagePaths; // Salvar na vari√°vel global
                
                resultado.innerHTML = `
                    <h3>Resultado:</h3>
                    <p><strong>Arquivos enviados:</strong> ${imagePaths.length}</p>
                    <p><strong>Caminhos:</strong></p>
                    <pre>${JSON.stringify(imagePaths, null, 2)}</pre>
                    <h4>Teste de Marcador:</h4>
                    <button onclick="testarMarcador()">Criar Marcador de Teste</button>
                `;
                
            } catch (error) {
                console.error('‚ùå Erro geral:', error);
                resultado.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
            }
        }
        
        async function testarMarcador() {
            console.log('üöÄ Testando cria√ß√£o de marcador com imagePaths:', uploadedImagePaths);
            
            const payload = {
                nome: 'Teste Upload',
                descricao: 'Teste de marcador com imagens',
                tipo: 'outro',
                latitude: -22.1207,
                longitude: -51.3889,
                imagePaths: uploadedImagePaths
            };
            
            console.log('üì§ Enviando payload para /lugares:', payload);
            
            try {
                const response = await fetch('http://localhost:3001/lugares', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Marcador criado:', data);
                    alert('Marcador criado com sucesso! ID: ' + data.id);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erro ao criar marcador:', errorText);
                    alert('Erro ao criar marcador: ' + errorText);
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro: ' + error.message);
            }
        }
    </script>
</body>
</html>
